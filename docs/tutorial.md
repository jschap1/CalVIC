# Tutorial

The shuffled complex evolution (SCE, Duan et al., 1992) algorithm is a heuristic global optimization algorithm that attempts to find an optimal parameter set to minimize some objective function. It has the following hyper-parameters:

* maxn - maximum number of function calls
* kstop - number of shuffling loops in which the criterion value must change by the given percentage before optimization is terminated
* pcento - percentage by which the criterion value must change in given number (kstop) of shuffling loops to continue optimization
* peps - convergence level for parameter set (lower number means smaller difference between parameters of the population required for stop)
* iseed - initial (random) seed. Used to ensure consistent results across experiments
* iniflg - flag for whether to count initial iteration
* ngs - number of complexes. More complexes makes it less likely that the algorithm with get stuck on a sub-optimal solution, but they are mean that it may take longer for the algorithm to converge.

```
# SCE hyper-parameters
maxn = 25;
kstop = 15; 
pcento = 1; 
peps = 0.01; 
iseed = 704753262; 
iniflg = 1; 
ngs = 2;
```

We are using a small number of complexes (2). This makes SCE converge in relatively few iterations, but at the cost of potentially getting stuck in a sub-optimal solution. This is a good option when you think you have a good initial guess.

Make an initial guess for the parameters: In this tutorial, we are calibrating *b*, *dsmax*, and *t3*, the infiltration capacity parameter, maximum baseflow velocity, and thickness of the third soil layer. We must also constrain the parameters between upper and lower bounds:

```
x0 = [0.11, 1.8, 1.8]; % initial guess
bl = [0.001, 0.5, 0.001]; % lower bounds
bu = [0.4, 2.5, 30]; % upper bounds
```

## Lumped UCRB calibration

The lumped UCRB model is a single-grid cell version of the distributed UCRB model. The meteorological forcings and the soil and vegetation parameter files have been averaged over the basin. This is much faster to run than the full, distributed version of the model, so I tested whether the calibrated parameters from the lumped model would be transferable to the distributed model.

For the lumped calibration, the following changes must be made to the SCE codes: 

Needed inputs: 
* name of soil parameter file
* name of global parameter file
* location of VIC run command
* name of VIC output file
* number of days of spin-up
* columns of baseflow and runoff in the VIC output file
* basin area
* name of validation data
* choice of objective function
* which parameters to calibrate

Currently, these are hard-coded into CalVIC's `vic_wrapper_sceua`, and also changes must be made to the `sceua` and `cceua` functions to set up a different model configuration. It would be preferable to specify these options without having to modify the source code. In an earlier version, I had set this up using a `control_params` structure containing all these inputs.

Call the `sceua` function, which has been modified for this particular model setup. 

```
[bestx,bestf,xf] = sceua(x0,bl,bu,maxn,kstop,pcento,peps,ngs,iseed,iniflg);
```

The outputs `bestx`, `bestf`, and `xf` are the optimal parameter values, optimal objective function values, and optimal objective function values at the end of each shuffling loop, respectively. After running the calibration, the VIC model can be run one more time to generate outputs using the optimal parameter set.

```
[kge, t_m, q_m, t, q] = vic_wrapper_sceua([], bestx, 9999, 1);
```

The `9999` is just an arbitrary index for the VIC run. At the end, you can calculate the objective function value (in this case KGE) using the predicted and observed discharge values output by `vic_wrapper_sceua`. 

```
kge = myKGE(q, q_m)
```

Set up the global parameter file, and run the calibration. We ran the simulation for WY (water years) 2002-2011, using initial soil moisture from a state file generated by running VIC for WY2001, starting with initial soil moisture (init_moist) equal to 70% of the critical point. This is a water-balance simulation with an hourly time step, so it takes about 17.5 seconds per function call. Takes about 8 minutes for the calibration.

The optimal parameter values were *b* = 0.1182, *Dsmax* = 1.842 mm/day, and *t3* = 1.826 m, with a KGE of 0.38.

![Plot of the simulated and observed discharge](/img/pred_v_obs_cal.png)

## Impact of initial soil moisture

Using simulated climatological average values as the initial conditions for soil moisture. Following Rodell et al. (2005) for land surface model initialization. 

1. Run VIC for the full WY2001-2011 period, using the baseline initial soil moisture, which is equal to the critical point (about 70% of field capacity). This is a relatively wet initial condition. I am using SSE between discharge time series from successive model runs as the criterion for whether convergence has been reached.
1. Repeat until soil moisture values stop changing
1. Use climatological average for Oct. 1 as the initial soil moisture.

I initialized soil moisture using the code `.../ESSD/codes/initial_sm.m`. After 5 iterations, the initial soil moisture values converged, and the average values on Oct. 1 were 13.0193, 30.7796, and 227.6586 mm for layers 1-3. Without performing soil moisture spin-up, we would be using initial moisture equal to 31.092, 62.184, and 231.166 mm, which means that we probably were overestimating soil moisture by quite a lot in the top two soil layers.

How does this affect the VIC simulation results?

![plot of soil moisture](/docs/img/soil_moisture_spinup.png)


![plot of discharge](/docs/img/q_spinup.png)

Agfain.
![plot of discharge](https://jschap1.github.io/CalVIC/img/q_spinup.png)


Agfain1
![plot of discharge](/img/q_spinup.png)




Initial soil moisture matters until around April 1, after that, it doesn't matter which initial soil moisture is used. This is for the lumped UCRB simulation. Results may not generalize for a distributed simulation or for other basins. Need to review the literature/do more research.

Butt. Butt.

## Distributed UCRB calibration

## Implementation on Hoffman2 computing cluster

## IRB sub-basin calibration